---
title: "Ramachandran Lineages"
output: html_notebook
---

Applying Ramachandran lineage signatures from https://doi.org/10.1038/s41586-019-1631-3.

```{r}
library(Seurat)
library(UCell)
library(ggplot2)
```

Load signatures from CSV.

```{r}
ramSig <- read.table("~/Dropbox/Zoe/scf_version/analysis/pathway_files/RamachandranSignatures.csv",
                     header = FALSE,
                     sep = ",",
                     fill = TRUE,
                     na.strings = "")
ramSig
```

Reformat CSV into list

```{r}
lineageNames <- ramSig$V1
# Create empty list
ramSigList <- list()
# Loop through all of the lineage names
for(num in 1:length(lineageNames)) {
  # Isolate each row that contains the corresponding gene signatures
  ramSigList[[num]] <- as.character(ramSig[num, 3:ncol(ramSig)])[!is.na(as.character(ramSig[num, 3:ncol(ramSig)]))]
}
# Apply lineage name to list
names(ramSigList) <- lineageNames
ramSigList
```

Replace genes that don't exist in woodchuck:
*HLA+AC0-DRA,LILRA4,~~CLEC4C~~,GZMB,KLRF1,KLRC1,~~IGHA2~~,TPSAB1,TPSB2,~~CYP2A6~~*
* Note that *TPSAB1* and *TPSB2* have the same orthologue in woodchuck

```{r}
for(num in 1:length(ramSigList)) {
  ramSigList[[num]] <- gsub("HLA+AC0-DRA", "HLA-DRA", ramSigList[[num]], fixed = TRUE)
  ramSigList[[num]] <- gsub("LILRA4", "LILRA4;LOC102725035;LOC107987425;LILRB3;LOC112268337;LOC107987441;LOC112268340;LOC112268336;LOC112268334;LOC107987462;LILRB5;LILRA6", ramSigList[[num]])
  ramSigList[[num]] <- gsub("GZMB", "GZMH;GZMB", ramSigList[[num]], fixed = TRUE)
  ramSigList[[num]] <- gsub("KLRF1", "Klrf1", ramSigList[[num]], fixed = TRUE)
  ramSigList[[num]] <- gsub("KLRC1", "KLRC4;KLRC3;KLRC2;KLRC1", ramSigList[[num]], fixed = TRUE)
  ramSigList[[num]] <- gsub("TPSAB1", "TPSAB1;TPSB2;TPSD1", ramSigList[[num]], fixed = TRUE)
}
ramSigList
```

Load liver map

```{r}
sobj <- readRDS("~/Dropbox/Zoe/scf_version/analysis/healthy_sc/seurat_objects/dropletQC_filtered/allIntegrated_kanchor5_noBiopsyHeps_dropletQCFiltered.RDS")
#Idents(sobj) <- "integrated_snn_res.0.4" # Lower resolution
Idents(sobj) <- "integrated_snn_res.1.2" # Higher resolution
```

Apply signatures with UCell

```{r}
sobj <- AddModuleScore_UCell(sobj, features = ramSigList, assay = "SCT")
signature.names <- paste0(names(ramSigList), "_UCell")
VlnPlot(sobj, features = signature.names, group.by = "integrated_snn_res.1.2")
FeaturePlot(sobj, reduction = "umap", features = signature.names, 
            order = T)
```

Because of imperfect orthologue matching, some of the signatures did not work so I think I'll just make my own simple signatures, kind of like the SCINA labels. Remind myself of the lineage signatures I need to make:

```{r}
lineageNames
```

```{r}
mySigs <- list()
mySigs$MP <- c("CD14","CD68","ITGAM","HLA-DRA","TYROBP","CTSS")
mySigs$pDC <- c("FLT3","CST3","IFI30","PLD4","PLBD1")
mySigs$ILC <- c("NKG7","GZMA","Klre1","KLRB1","KLRD1","KLRC4;KLRC3;KLRC2;KLRC1")
mySigs$TCell <- c("CD3E","CD3D","CD3G","CD8A")
mySigs$BCell <- c("CD79A","CD79B","MS4A1","BIRC3","CD19")
mySigs$PlasmaCell <- c("JCHAIN","MZB1","GSTP1","IGLL5-1","IGLL5-2")
mySigs$MastCell <- c("FCER1A","MS4A2","Prss34","Prss29","IL3RA")
mySigs$Endothelia <- c("STAB1","STAB2","BMPER","RAMP2","CLEC4G")
mySigs$Mesenchyme <- c("COL1A1","COL1A2","COL3A1","DCN","HHIP")
mySigs$Hepatocyte <- c("CYP2E1","FETUB","PCK1","Saa2;Saa1-1","ACACB")
mySigs$Cholangiocyte <- c("EPCAM","KRT19","SLC4A4","ANXA2")
mySigs$Cycling <- c("MKI67","STMN1","TOP2A", "BRCA2")
```

Apply new signatures with UCell

```{r}
sobj <- AddModuleScore_UCell(sobj, features = mySigs, assay = "SCT")
signature.names <- paste0(names(mySigs), "_UCell")
```

Visualise

```{r}
VlnPlot(sobj, features = signature.names, group.by = "scina_labels_refined") +
  theme(plot.title = element_text(size=4))
FeaturePlot(sobj, reduction = "umap", features = signature.names[1:4], 
            order = T) & NoLegend() +
  theme(plot.title = element_text(size=4))
FeaturePlot(sobj, reduction = "umap", features = signature.names[5:8], 
            order = T) & NoLegend() +
  theme(plot.title = element_text(size=4))
FeaturePlot(sobj, reduction = "umap", features = signature.names[9:12], 
            order = T) & NoLegend() +
  theme(plot.title = element_text(size=4))
dotplot <- DotPlot(subset(sobj, downsample = 500),
                   features = signature.names,
                   group.by = "scina_labels_refined") + 
  RotatedAxis() +
  theme(axis.text = element_text(size = 8))
dotplot & NoLegend()
```
