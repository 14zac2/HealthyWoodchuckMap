---
title: "Stimulation experiments"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

Analysis of stimulation experiments.

```{r}
library(Seurat)
library(dplyr)
library(ggplot2)
library(scClustViz)
library(SeuratWrappers)
library(scCustomize)
library(reshape2)
library(viridis)
```

Load integrated object. This object has been integrated with CCA, because there was lots of batch effect between the 0hr tissue and the other two experiments (which merged quite well).

```{r}
load("~/Dropbox/Zoe/scf_version/analysis/healthy_sc/seurat_objects/no_dropletQC/3391/integrated_3391_stimulation_pmaio_unstim_downsampled_cca_kanchor5_scClustViz.RData")
# Set identity
Idents(scSeurat) <- "integrated_snn_res.0.4"
```

Check out the UMAP of clusters, original identities, and refined SCINA labels.

```{r}
DimPlot(scSeurat, label = TRUE)
DimPlot(scSeurat, group.by = "tissue_type", label = FALSE)
DimPlot(scSeurat, group.by = "scina_labels", label = TRUE) & NoLegend()
```

```{r}
pdf(file = './figures/stimulation/downsampled_UMAP.pdf')
DimPlot(scSeurat, label = TRUE)
dev.off()
pdf(file = './figures/stimulation/downsampled_tissue_type_UMAP.pdf',
    height = 5, width = 7)
DimPlot(scSeurat, group.by = "tissue_type") +
  ggtitle(NULL)
dev.off()
```

Create UMAP of general cell-type labels

```{r}
plot <- DimPlot(scSeurat, group.by = "general_cell_labels_clusts", label = TRUE, repel = TRUE) +
  labs(title = NULL) & NoLegend()
plot
pdf("./figures/stimulation/downsampled_general_cell_type_UMAP.pdf",
    height = 5, width = 7)
plot
dev.off()
```


Look at tissue-type per cluster on a proportional level:

```{r}
pt <- table(scSeurat$general_cell_labels_clusts, scSeurat$tissue_type)
pt <- as.data.frame(pt)
plot <- ggplot(pt, aes(x = Var1, y = Freq, fill = Var2)) +
  theme_bw(base_size = 15) +
  geom_col(position = "fill", width = 0.5) +
  xlab("Cluster") +
  ylab("Proportion") +
  theme(legend.title = element_blank(),
        legend.position = "top")
#print(plot, vp = viewport(angle = 90))
plot + coord_flip()
pdf(file = './figures/stimulation/downsampled_tissue_type_barplot.pdf',
    height = 5, width = 7)
plot + coord_flip()
dev.off()
```

Calculate all DE genes

```{r}
all.markers <- FindAllMarkers(scSeurat,
                              only.pos = TRUE,
                              min.pct = 0.25, 
                              logfc.threshold = 0.25,
                              recorrect_umi = FALSE)
top.markers <- all.markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC)
top.markers
write.table(all.markers,
            file = "./figures/stimulation/downsampled_cluster_markers.tsv",
            sep = "\t",
            quote = FALSE,
            row.names = FALSE)
```

Calculate DE genes: for each cluster, compare stim VS unstim

```{r}
for (clust in levels(as.factor(Idents(scSeurat)))) {
  cells_stim <- colnames(scSeurat)[Idents(scSeurat) == clust & scSeurat$tissue_type == "6hrs_PMAIO"]
  cells_unstim <- colnames(scSeurat)[Idents(scSeurat) == clust & scSeurat$tissue_type == "6hrs_unstim"]
  markers <- RunPresto(scSeurat,
                       ident.1 = cells_stim,
                       ident.2 = cells_unstim,
                       only.pos = FALSE,
                       min.pct = 0.25,
                       logfc.threshold = 0.25,
                       recorrect_umi = FALSE)
  write.table(markers,
              file = paste("./figures/stimulation/downsampled_markers_cluster", 
                           clust ,"_stim_vs_unstim.tsv", sep = ""),
              sep = "\t",
              quote = FALSE,
              row.names = TRUE)
}
```

Look for T-cell signatures.

```{r}
FeaturePlot(scSeurat, features = c("CD3E", "NKG7"))
FeaturePlot(scSeurat, features = c("LEF1", "XCL1;XCL2"))
FeaturePlot(scSeurat, features = c("TOX", "CD8A"))
FeaturePlot(scSeurat, features = c("CCR7"))
```

Look for macrophage signatures:

```{r}
FeaturePlot(scSeurat, features = c("LGALS1", "TYROBP"))
FeaturePlot(scSeurat, features = c("MARCO", "C1QC"))
FeaturePlot(scSeurat, features = c("LYZ-1", "S100A8"))
FeaturePlot(scSeurat, features = c("DEFA6;DEFA4;DEFA5", "CTSS"))
FeaturePlot(scSeurat, features = c("FLT3", "S100A12"))
```

Look for B and plasma cell signatures

```{r}
FeaturePlot(scSeurat, features = c("CD79B", "JCHAIN"))
```


Cluster 12 is the only cluster that is obviously dominated by the unstimulated experiments. What cells are these? Looks like they are hepatocytes. A lot of the markers are periportal, but all hepatocytes are in this cluster.

```{r}
# Isolate DE genes
clust11 <- sCVdata_list$res.0.4@DEvsRest$`12`[order(sCVdata_list$res.0.4@DEvsRest$`12`$Wstat,
                                                    decreasing = TRUE), ]
rownames(clust11)[1:50]
FeaturePlot(scSeurat, features = c("PAH","PCK1"))
FeaturePlot(scSeurat, features = c("CYP2E1","FETUB"))
FeaturePlot(scSeurat, features = c("ACACB","ELOVL6"))
FeaturePlot(scSeurat, features = c("POLR2D", "ALB-1"))
```

Let's look at some of the key markers that Sonya sent: IL2, IL4, IL6, IL7, IL10, IL12A, TGFB

```{r}
FeaturePlot(scSeurat, features = c("IL2", "IL4"))
FeaturePlot(scSeurat, features = c("IL6", "IL6-1"))
FeaturePlot(scSeurat, features = c("IL7", "IL10"))
FeaturePlot(scSeurat, features = c("IL12A", "TGFB1"))
```

It's pretty hard to see which cytokines are expressed in which samples, so I'm going to try splitting up the samples.

```{r}
DimPlot(scSeurat, split.by = "tissue_type", label = TRUE) & NoLegend()
pdf(file = './figures/stimulation/downsampled_UMAP_split.pdf',
    height = 4, width = 8)
DimPlot(scSeurat, split.by = "tissue_type", label = TRUE) & NoLegend()
dev.off()
```

Now let's take a look at the features on this split plot.

```{r}
genes <- c("IL2","IL4","IL6","IL7","IL10","IL12A","TGFB1","TGFB2","TGFB3","TNF","IL18","IL2RA","CCL5","IFNG","LIF", "CCL3L1;CCL3L3;CCL3;CCL18","CCL4L2;CCL4L1;CCL4","NFKB1","ACTB","PTPRC","CD3E","TBP","SDHA")
for (gene in genes) {
  plots <- FeaturePlot_scCustom(scSeurat, feature = gene, split.by = "tissue_type",
                     colors_use = viridis_light_high)
  plot1 <- plots[[2]] + NoLegend() + labs(title = NULL)
  plot2 <- plots[[1]] + theme(axis.line.y = element_blank(),
                   axis.ticks.y = element_blank(),
                   axis.text.y = element_blank(),
                   axis.title.y = element_blank()) +
    labs(title = NULL)
  if (gene == "CCL3L1;CCL3L3;CCL3;CCL18" | gene == "CCL4L2;CCL4L1;CCL4") {
    plot2 <- plot2 + theme(legend.title = element_blank())
  }
  print(plot1 + plot2)
  #pdf(paste("figures/stimulation/downsampled_UMAP_split_", gene, ".pdf", sep = ""),
  #    height = 4, width = 8)
  #print(plot1 + plot2)
  #dev.off()
}
```

# Stim vs unstim heatmap

Look at the same features on a heatmap:

```{r}
# Make ordered list of genes to visualise
genes <- c("ACTB","PTPRC","CD3E","TBP","SDHA","NFKB1","CCL3L1;CCL3L3;CCL3;CCL18","CCL4L2;CCL4L1;CCL4","CCL5",
           "TNF","IFNG","IL2RA","IL2","IL4","IL6","IL7","IL10")
# Loop through clusters
for (clust in c("1","2", "5")) {
  # Isolate RNA expression and tissue type
  dat <- t(as.data.frame(scSeurat@assays$SCT@data[genes,
                                                  scSeurat$integrated_snn_res.0.4 == clust]))
  tissue_type <- as.data.frame(scSeurat$tissue_type[scSeurat$integrated_snn_res.0.4 == clust])
  colnames(tissue_type) <- "tissue_type"
  dat <- cbind(dat, tissue_type)
  # Replace specific gene names
  colnames(dat) <- gsub("CCL3L1;CCL3L3;CCL3;CCL18", "CCL3", colnames(dat))
  colnames(dat) <- gsub("CCL4L2;CCL4L1;CCL4", "CCL4", colnames(dat))
  # Find average values across tissue types
  sumDat <- dat %>% group_by(tissue_type) %>% summarise_each(funs = mean)
  sumDat <- melt(sumDat, value.name = "expression")
  # Create heatmap with ggplot
  plot <- ggplot(sumDat, aes(x = variable, y = tissue_type, fill = expression)) + 
    geom_tile() +
    scale_fill_viridis(name = "Avg Expression") +
    ggplot2::theme_minimal() +
    ggplot2::theme(axis.title.x = ggplot2::element_blank(),
                   axis.title.y = ggplot2::element_blank())
  print(plot)
  if (clust == "1") {
    cells <- "myeloid"
  } else if (clust == "2") {
    cells <- "t_cell"
  } else if (clust == "5") {
    cells <- "hepatocyte"
  }
  pdf(paste("./figures/stimulation/downsampled", cells, "key_marker_heatmap.pdf", sep = "_"),
    height = 2, width = 14)
  print(plot)
  dev.off() 
}
```

```{r}
DotPlot(scSeurat,
        features = genes,
        group.by = "general_cell_labels_clusts",
        split.by = "tissue_type")
        #idents = "CD3+ NK/T cells (2)")
```



More plots

```{r}
FeaturePlot(scSeurat, feature = "IL15", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL16", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL17B", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL6ST", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL31RA", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL7R", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL7R-1", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL17D", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL5RA", split.by = "tissue_type") 
FeaturePlot(scSeurat, feature = "IL17RE", split.by = "tissue_type") 
FeaturePlot(scSeurat, feature = "IL17RC", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL17C", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL34", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL4I1", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL11", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL9R", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL4R", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL21R", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL27", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "ILK", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL18BP", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL10RA", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL3", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "CSF2", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IFNK", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL9", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL13", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "OSM", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "LIF", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "STAT1", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "STAT4", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL4", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL4I1", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "CD69", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "TLR7", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "HLA-DRA", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "IL12A", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "TLR2", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "NFKB1", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "ACTB", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "PTPRC", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "CD3E", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "TBP", split.by = "tissue_type")
FeaturePlot(scSeurat, feature = "SDHA", split.by = "tissue_type")
```


Cluster 2 looks like it generally has more IL genes expressed. Isolate DE genes for this cluster.

```{r}
clust1 <- sCVdata_list$res.0.4@DEvsRest$`2`[order(sCVdata_list$res.0.4@DEvsRest$`2`$Wstat,
                                                    decreasing = TRUE), ]
cat(rownames(clust1)[1:50])
```

Visualise these genes in violin plots.

**Interpretation**: Now I see that IL2 and IL4 are expressed in more than just cluster 2, but it is nearly always in PMAIO. Cluster 8 is definitely where IL6 is expressed. IL7 is a bit more spread out across treatment types, but it's definitely present in PMAIO in clusters 4, 5, and 11. Cluster 11 is plasma cells, but I'm honestly not sure of 4 and 5 - low signal hepatocytes? IL10 is in clusters 2 and 11 PMAIO. IL12A is a bit more in 4 and 5 PMAIO.

```{r}
VlnPlot(scSeurat, feature = "IL2", split.by = "tissue_type") # Only in PMAIO cluster 2
VlnPlot(scSeurat, feature = "IL4", split.by = "tissue_type") # Only in PMAIO cluster 2
VlnPlot(scSeurat, feature = "IL6", split.by = "tissue_type") # Stronger in endo and mesem PMAIO
VlnPlot(scSeurat, feature = "IL6-1", split.by = "tissue_type") # No signal
VlnPlot(scSeurat, feature = "IL7", split.by = "tissue_type") # More in PMAIO cluster 4/5
VlnPlot(scSeurat, feature = "IL10", split.by = "tissue_type") # More in PMAIO cluster 2
VlnPlot(scSeurat, feature = "IL12A", split.by = "tissue_type") # A bit more in 1,4,5
VlnPlot(scSeurat, feature = "TGFB1", split.by = "tissue_type") # Pretty even across all
VlnPlot(scSeurat, feature = "TNF", split.by = "tissue_type")
```

Make Violin plots with ggplot

```{r}
genes <- c("IL2","IL4","IL6","IL7","IL10","IL12A","TGFB1","TGFB2","TGFB3","TNF","IL18","IL2RA","CCL5","IFNG","LIF","CCL3L1;CCL3L3;CCL3;CCL18","CCL4L2;CCL4L1;CCL4")
for(gene in genes) {
  vln_df = data.frame(gene = scSeurat[["RNA"]]@data[gene,], 
                      Cluster = Idents(scSeurat), 
                      tissue_type = scSeurat$tissue_type)
  plot <- ggplot(vln_df, aes(x = Cluster, y = gene)) + 
    geom_violin(aes(fill = tissue_type), trim=TRUE, scale = "width") +
    ylab(gene) +
    theme_bw()
  print(plot)
  pdf(file = paste("figures/stimulation/downsampled_vlnPlot_split_", gene, ".pdf", sep = ""))
  print(plot) # Need print function because R doesn't autoprint in loops
  dev.off()
}
```

Looking for more genes

```{r}
gene <- "IL18"
vln_df = data.frame(gene = scSeurat[["RNA"]]@data[gene,], 
                    Cluster = Idents(scSeurat), 
                    tissue_type = scSeurat$tissue_type)
plot <- ggplot(vln_df, aes(x = Cluster, y = gene)) + 
  geom_violin(aes(fill = tissue_type), trim=TRUE, scale = "width") +
  ylab(gene) +
  theme_bw()
print(plot)
```

Make heatmap with select genes

```{r}
genes <- c("IL2","IL4","IL6","IL7","IL10","IL12A","TGFB1","TGFB2","TGFB3","TNF","IL18","IL2RA","CCL5","IFNG","LIF","CCL3L1;CCL3L3;CCL3;CCL18","CCL4L2;CCL4L1;CCL4")
DoHeatmap(scSeurat, features = genes, group.by = "integrated_snn_res.0.4",
          size = 3, 
          angle = 90, assay = "RNA", slot = "data") +
  NoLegend() +
  theme(text = element_text(size = 7))
DotPlot(scSeurat,
        assay = "RNA",
        features = genes,
        group.by = "integrated_snn_res.0.4",
        split.by =  "tissue_type")
DotPlot(scSeurat,
        assay = "RNA",
        features = genes,
        group.by = "tissue_type")
DotPlot(scSeurat,
        assay = "RNA",
        features = genes,
        group.by = "integrated_snn_res.0.4")
```


Perform DE test on T-cells from PMAIO vs unstim T-cells. I see *TNF, IL2RA*, but I also see hepatocyte genes like *ALB-1, STAT3*

```{r}
# Fetch cells to find out relevant cell barcodes
barcode_df <- FetchData(scSeurat, vars = c("tissue_type", "integrated_snn_res.0.4"))
barcode_df$barcode <- rownames(barcode_df)
# Filter on data subsets and pull barcode names
cells1 <- barcode_df %>%
  filter(tissue_type == "6hrs_PMAIO") %>%
  filter(integrated_snn_res.0.4 %in% c(2,6)) %>%
  pull(barcode)
cells2 <- barcode_df %>%
  filter(tissue_type == "6hrs_unstim") %>%
  filter(integrated_snn_res.0.4 %in% c(2,6)) %>%
  pull(barcode)
# Prep for DE testing
scSeurat <- PrepSCTFindMarkers(scSeurat)
# Perform DE test
de_results <- FindMarkers(scSeurat,
            ident.1 = cells1,
            ident.2 = cells2)
cat(row.names(de_results)[1:100], sep = " ")
```


