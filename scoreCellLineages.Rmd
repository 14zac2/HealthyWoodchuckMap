---
title: "Lineage Scoring"
output: html_notebook
---

```{r}
library(Seurat)
library(UCell)
library(ggplot2)
```

# Ramachandran

Applying Ramachandran lineage signatures from https://doi.org/10.1038/s41586-019-1631-3. Load signatures from CSV.

```{r}
ramSig <- read.table("~/Dropbox/Zoe/scf_version/analysis/pathway_files/RamachandranSignatures.csv",
                     header = FALSE,
                     sep = ",",
                     fill = TRUE,
                     na.strings = "")
ramSig
```

Reformat CSV into list

```{r}
lineageNames <- ramSig$V1
# Create empty list
ramSigList <- list()
# Loop through all of the lineage names
for(num in 1:length(lineageNames)) {
  # Isolate each row that contains the corresponding gene signatures
  ramSigList[[num]] <- as.character(ramSig[num, 3:ncol(ramSig)])[!is.na(as.character(ramSig[num, 3:ncol(ramSig)]))]
}
# Apply lineage name to list
names(ramSigList) <- lineageNames
ramSigList
```

Replace genes that don't exist in woodchuck:
*HLA+AC0-DRA,LILRA4,~~CLEC4C~~,GZMB,KLRF1,KLRC1,~~IGHA2~~,TPSAB1,TPSB2,~~CYP2A6~~*
* Note that *TPSAB1* and *TPSB2* have the same orthologue in woodchuck

```{r}
for(num in 1:length(ramSigList)) {
  ramSigList[[num]] <- gsub("HLA+AC0-DRA", "HLA-DRA", ramSigList[[num]], fixed = TRUE)
  ramSigList[[num]] <- gsub("LILRA4", "LILRA4;LOC102725035;LOC107987425;LILRB3;LOC112268337;LOC107987441;LOC112268340;LOC112268336;LOC112268334;LOC107987462;LILRB5;LILRA6", ramSigList[[num]])
  ramSigList[[num]] <- gsub("GZMB", "GZMH;GZMB", ramSigList[[num]], fixed = TRUE)
  ramSigList[[num]] <- gsub("KLRF1", "Klrf1", ramSigList[[num]], fixed = TRUE)
  ramSigList[[num]] <- gsub("KLRC1", "KLRC4;KLRC3;KLRC2;KLRC1", ramSigList[[num]], fixed = TRUE)
  ramSigList[[num]] <- gsub("TPSAB1", "TPSAB1;TPSB2;TPSD1", ramSigList[[num]], fixed = TRUE)
}
ramSigList
```

Load liver map

```{r}
#sobj <- readRDS("~/Dropbox/Zoe/scf_version/analysis/healthy_sc/seurat_objects/dropletQC_filtered/allIntegrated_kanchor5_noBiopsyHeps_dropletQCFiltered.RDS")
#Idents(sobj) <- "integrated_snn_res.0.4" # Lower resolution
#Idents(sobj) <- "integrated_snn_res.1.2" # Higher resolution
sobj <- readRDS("~/Dropbox/Zoe/scf_version/analysis/healthy_sc/seurat_objects/dropletQC_filtered/allIntegrated_cca_kanchor5_noBiopsyHeps_dropletQCFiltered.RDS")
tissue <- "liver"
```

Apply signatures with UCell

```{r}
sobj <- AddModuleScore_UCell(sobj, features = ramSigList, assay = "SCT")
signature.names <- paste0(names(ramSigList), "_UCell")
VlnPlot(sobj, features = signature.names, group.by = "integrated_snn_res.1.2")
FeaturePlot(sobj, reduction = "umap", features = signature.names, 
            order = T)
```

# Personal signatures

Because of imperfect orthologue matching, some of the signatures did not work so I think I'll just make my own simple signatures, kind of like the SCINA labels. Remind myself of the lineage signatures I need to make:

```{r}
lineageNames
```

```{r}
mySigs <- list()
mySigs$MP <- c("CD14","CD68","ITGAM","HLA-DRA","TYROBP","CTSS")
mySigs$pDC <- c("FLT3","CST3","IFI30","PLD4","PLBD1")
mySigs$ILC <- c("NKG7","GZMA","Klre1","KLRB1","KLRD1","KLRC4;KLRC3;KLRC2;KLRC1")
mySigs$TCell <- c("CD3E","CD3D","CD3G","CD8A")
mySigs$BCell <- c("CD79A","CD79B","MS4A1","BIRC3","CD19")
mySigs$PlasmaCell <- c("JCHAIN","MZB1","GSTP1","IGLL5-1","IGLL5-2")
mySigs$MastCell <- c("FCER1A","MS4A2","Prss34","Prss29","IL3RA")
mySigs$Endothelia <- c("STAB1","STAB2","BMPER","RAMP2","CLEC4G")
mySigs$Mesenchyme <- c("COL1A1","COL1A2","COL3A1","DCN","HHIP")
mySigs$Hepatocyte <- c("CYP2E1","FETUB","PCK1","Saa2;Saa1-1","ACACB")
mySigs$Cholangiocyte <- c("EPCAM","KRT19","SLC4A4","ANXA2")
mySigs$Cycling <- c("MKI67","STMN1","TOP2A", "BRCA2")
```

Apply new signatures with UCell

```{r}
sobj <- AddModuleScore_UCell(sobj, features = mySigs, assay = "SCT")
signature.names <- paste0(names(mySigs), "_UCell")
```

Visualise

```{r}
VlnPlot(sobj, features = signature.names, group.by = "scina_labels_refined") +
  theme(plot.title = element_text(size=4))
FeaturePlot(sobj, reduction = "umap", features = signature.names[1:4], 
            order = T) & NoLegend() +
  theme(plot.title = element_text(size=4))
FeaturePlot(sobj, reduction = "umap", features = signature.names[5:8], 
            order = T) & NoLegend() +
  theme(plot.title = element_text(size=4))
FeaturePlot(sobj, reduction = "umap", features = signature.names[9:12], 
            order = T) & NoLegend() +
  theme(plot.title = element_text(size=4))
dotplot <- DotPlot(subset(sobj, downsample = 500),
                   features = signature.names,
                   group.by = "scina_labels_refined") + 
  RotatedAxis() +
  theme(axis.text = element_text(size = 8))
dotplot & NoLegend()
```

# Signatures for paper

Create new signatures using markers from Sherry

```{r}
sigs <- "sherry"
mySigs <- list()
mySigs$Cytotoxic_T_Cells <- c("CD3E","CD8A","GZMH;GZMB","GZMK","IFNG","LTA","ITK","IKZF1",
                              "CST7","EOMES","TIGIT")
mySigs$Tissue_Resident_Memory_T_Cells <- c("CD3E","CD2","GZMK","CCL5","CCL4L2;CCL4L1;CCL4","CD69")
mySigs$Natural_Killer_Cells <- c("CD8A","NKG7","Krt86","TBX21","SH2D1A","KRT73", 
                                 "CD160","IL21R","PRF1","IKZF3","CCL4L2;CCL4L1;CCL4")
mySigs$Regulatory_T_Cells <- c("LEF1","CD4","CTLA4","CD3E")
mySigs$Kupffer_Cells <- c("CD68","MARCO","CD5L","C1QB","C1QC","ITGAM","TREM2","CD163","Clec4f",
                          "VSIG4","TIMD4")
mySigs$Myeloid_Cells <- c("CD14","LCP2","FCGR3A;FCGR3B","VCAN","S100A8","S100A9","S100A12")
mySigs$Mesenchymal_Cells <- c("ACTA2","COL1A2","COL3A1","IGFBP7","IGFBP3","DCN","CALCRL","COL1A1")
mySigs$Megakaryocytes <- c("PPBP","PF4;PF4V1","TREML1","GP9")
mySigs$Hematopoietic_Stem_Cells <- c("VIM","CD74")
mySigs$B_Cells <- c("BCL2","JCHAIN","MZB1","IGLL5-1","CD79B","MS4A1","DGKK","CD72","BANK1","BIRC3")
mySigs$Dendritic_Cells <- c("CD1C","CD1E","CLEC9A","CST3","FLT3")
mySigs$Cholangiocytes <- c("KRT19","CFTR","CAPN12","SLC4A4")
mySigs$Endothelial_Cells <- c("LYVE1","STAB2","VWF","CD34")
mySigs$Mast_Cells <- c("FCER1A","MS4A2","Prss34","Prss29")
mySigs$Erythrocytes <- c("HBD;HBB","HBA2;HBA1","ALAS2","ISCA1")
mySigs$Proliferative <- c("BRCA2","STMN1","TOP2A")
```

Now use markers from CZI

```{r}
sigs <- "czi"
mySigs <- list()
mySigs$B_Cell <- c("CD79A","CD79B")
#mySigs$Naive_B <- c("IGHM") # Gene not found
mySigs$Plasma_B <- c(#"IGHA1","IGHA2","IGHG1","IGHG2",
                     #"IGHG3","IGHG4","IGHGP","IGKC",
                     #"IGLC2","IGLC3",
                     "IGLL5-1")
mySigs$Cellcycle <- c("BIRC5","CDC20","CDK1","CDK4",
                      "HMGB2","MKI67","TOP2A")
mySigs$Apo_Lipo_Chol <- c("APOA1","APOA2","APOC1","APOC3")
mySigs$Cholangio <- c("AGXT","AMBP","ANXA4","CLDN1",
                      "DEFB1","EEF1A1","EPCAM",#"FXYD2",
                      #"GNB2L1",
                      "HP;HPR","MT2A",#"NEAT1",
                      "RPL3")
mySigs$Keratins_Chol <- c("KRT18","KRT19","KRT7","KRT8")
mySigs$Mucus_Secreting <- c("LGALS2","MUC1","MUC3A","MUC5B",
                            "PIGR","SCGB3A1","SLPI","SPINK1",
                            "TFF3")
mySigs$Arterial <- c("CD34","PLVAP","PODXL")
mySigs$cvEndo <- c("ACKR1","RSPO3","WNT2")
mySigs$cvLSEC <- c("CLEC1B","CLEC4G","CLEC4M;CD209","CLEC4M;CD209-1",
                   "CLEC4M;CD209-2","CRHBP",
                   "FCN2;FCN1", #"FCN3",
                   "STAB1","STAB2")
mySigs$Endothelial <- c("C7","DNASE1L3","ENG","GSN",
                        "INMT","LIFR","PECAM1","PLAC8",
                        "RAMP3","TIMP3","VWF")
mySigs$ppLSEC <- c(#"ADRIF",
                   "AQP1","CLEC14A","ID1",
                   "IGFBP7","MGP","S100A6","SPARCL1",
                   "TM4SF1")
mySigs$C_Hepato <- c("ADH1C;ADH1B;ADH1A","ADH4",
                     "CES1","CYP2E1","CYP3A4;CYP3A7-CYP3A51P;CYP3A7",
                     "CYP3A4;CYP3A7-CYP3A51P;CYP3A7-1",
                     "CYP3A4;CYP3A7-CYP3A51P;CYP3A7-2",
                     "CYP3A4;CYP3A7-CYP3A51P;CYP3A7-3",
                     "DCXR","GSTA3;GSTA5;GSTA1;GSTA2",
                     "GSTA3;GSTA1","OAT")
mySigs$Hepatocyte <- c("ASGR1","SERPINA1")
mySigs$P_Hepato <- c("AGT","ALB-1","ALDOB","APOA1",
                     "CYP1A2","CYP2A13;CYP2A6;CYP2A7",
                     "CYP2A13;CYP2A6;CYP2A7",
                     "CYP2D6;LOC107987479;LOC107987478",
                     "CYP2D6;LOC107987479;LOC107987478-1",
                     "FGA","FGB","GLS2","HAL",
                     "HAMP","SDS")
mySigs$abT <- c("CD3D","CD3E")#,"TRAC","TRBC2")
mySigs$CD4_T <- c("CD4","CD40LG","IL7R","LTB",
                  "RCAN3","S100A4","SPOCK2")
mySigs$CD8_T <- c("CD8A","CD8B;CD8B2")
mySigs$cNK <- c("FCGR3A;FCGR3B",#"GNLY",
                "GZMH;GZMB","GZMH;GZMB-1","GZMH;GZMB-2",
                "GZMH;GZMB-3","TBX21",
                "XCL1;XCL2")
mySigs$gdT <- c("CD7","CTSW","GATA3") #"TRDC",
                #"TRGC1","TRGC2")
mySigs$lrNK <- c("CD69","CMC1","EOMES","GZMK",
                "KLRC4;KLRC3;KLRC2;KLRC1","Klrf1","XCL1;XCL2")
mySigs$Activated_Mac <- c("AREG","CCL3L1;CCL3L3;CCL3;CCL18",
                          "CCL3L1;CCL3L3;CCL3;CCL18-1",
                          "CCL3L1;CCL3L3;CCL3;CCL18-2",
                          "CCL3L1;CCL3L3;CCL3;CCL18-3",
                          "CD83","CXCL2;CXCL3;CXCL1",
                          "CXCL2;CXCL3;CXCL1-1",
                          "IL1B","NAMPT","PLAUR",
                          "SRGN","THBS1")
mySigs$Kupffer <- c("C1QB","C1QC","CD163",
                    "CD5L","CTSB","FTL","HMOX1",
                    "MARCO","SELENOP","SLC40A1","VCAM1")
mySigs$LAM_like <- c("ACP5","CSTB","FABP5","LGMN",
                     "PLD3","PSAP")
mySigs$Macrophage <- c("APOE","CD14",#"CD54",
                       "CD68","FTH1","IL18","NINJ1",
                       "PLAC8","PLTP","VSIG4")
mySigs$MHCII_cDC <- c("CD74","HLA-DPA1","HLA-DQB2;HLA-DQB1",
                      "HLA-DRA","HLA-DRB5;HLA-DRB1;HLA-DRB3;HLA-DRB4")
mySigs$Monocyte_derived <- c("FCN2;FCN1","LYZ-1",#"MNDA",
                             "S100A12","S100A4","S100A6","S100A8",
                             "S100A9","VCAN")
mySigs$Myeloid <- c("CST3")
mySigs$Neutrophil <- c("BASP1","CSF3R","CXCL8","CXCR1",
                       "CXCR2","FCGR3A;FCGR3B","FPR1","G0S2",
                       "IFITM3;IFITM2;IFITM1","IFITM3;IFITM2;IFITM1-1",
                       "IFITM3;IFITM2;IFITM1-2","IFITM3;IFITM2;IFITM1-3",
                       "S100A11")
mySigs$Resident_Mac <- c("FCER1G","FOLR2","LYVE1",#"MS4A7",
                         "TIMD4","TIMP1")
mySigs$Synapse_Mac <- c("AIF1","COTL1",
                        "IFITM3;IFITM2;IFITM1","IFITM3;IFITM2;IFITM1-1",
                        "IFITM3;IFITM2;IFITM1-2","IFITM3;IFITM2;IFITM1-3")
                        #"LST1")
mySigs$RBC <- c("HBA2;HBA1","HBD;HBB")
mySigs$AP1_Stellate <- c("CCL13;CCL2","FBLN5","FOSB","JUNB",
                         "PDGFRA","SOCS3","SOD2")
mySigs$Quiescent_Stellate <- c("COLEC11","HGF","PTH1R","RBP1",
                               "RELN","VIPR1")
mySigs$Stellate_Fiber <- c("ACTA2","COL1A1","COL1A2",#"MYL9",
                           "TAGLN")
mySigs$VSMC <- c("CD9","CRYAB","PMEPA1","RGCC")
```


Check certain genes with Feature Plot

```{r}
FeaturePlot(sobj, features = c("CD68","MARCO","CD5L","C1QB","C1QC","ITGAM","TREM2","CD163","Clec4f",
                               "VSIG4","TIMD4","Cd163l1;5830411N06Rik"))
```

Apply signatures with UCell

```{r}
sobj <- AddModuleScore_UCell(sobj, features = mySigs, assay = "SCT")
signature.names <- paste0(names(mySigs), "_UCell")
```

Plot dotplot

```{r}
dotplot <- DotPlot(subset(sobj, downsample = 500),
                   features = signature.names,
                   group.by = "general_cell_labels") + 
  scale_colour_viridis(option="magma") +
  RotatedAxis() +
  labs(y = "Cell type", x = "Lineage signature")
  #theme(axis.text = element_text(size = 8))
dotplot
pdf(paste("./figures/", tissue, "/", tissue, "_", 
          sigs ,"_lineage_dotplot.pdf", sep = ""),
    height = 8, width = 14)
dotplot
dev.off()
```

# Dotplot of genes composing signatures

View these genes as a dotplot.

```{r}
newSigs <- unique(unlist(mySigs))
newSigs <- newSigs[newSigs != "TFF3"]
newSigs <- newSigs[newSigs != "SCGB3A1"]
newSigs <- newSigs[newSigs != "TAGLN"]
dotplot <- DotPlot(subset(sobj, downsample = 500),
                   features = newSigs,
                   group.by = "general_cell_labels") + 
  scale_colour_viridis(option="magma") +
  RotatedAxis() +
  labs(y = "Cell type", x = "Human marker genes")
  #theme(axis.text = element_text(size = 8))
dotplot
pdf(paste("./figures/", tissue, "/", tissue, "_", 
          sigs ,"_lineageGenes_dotplot.pdf", sep = ""),
    height = 8, width = 50)
dotplot
dev.off()
```

